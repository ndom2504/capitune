// Generated by Prisma Client

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== USERS & AUTH =====
model User {
  id            String     @id @default(cuid())
  email         String     @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  dateOfBirth   DateTime?
  role          Role       @default(CANDIDATE)
  status        UserStatus @default(ACTIVE)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  // Relations
  dossiers      Dossier[]
  messages      Message[]
  posts         Post[]
  comments      Comment[]
  eventReg      EventRegistration[]
  notifications Notification[]
  internalNotes InternalNote[]

  @@index([email])
  @@index([role])
}

enum Role {
  CANDIDATE
  PROFESSIONAL
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  DELETED
}

// ===== DOSSIERS (Core) =====
model Dossier {
  id            String   @id @default(cuid())
  candidateId   String
  candidate     User     @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  
  status        DossierStatus @default(IN_PROGRESS)
  currentStep   DossierStep   @default(PROFILE)
  
  // Budget & Options
  selectedPath  PathType @default(STUDIES) // Ã‰tudes | Travail | Entrepreneur
  estimatedBudget Int?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  documents     Document[]
  checklist     DossierChecklist[]
  messages      Message[]
  internalNotes InternalNote[]

  @@index([candidateId])
  @@index([status])
}

enum DossierStatus {
  IN_PROGRESS
  PENDING_DOCS
  AWAITING_REVIEW
  COMPLETED
  SUBMITTED
  ARCHIVED
}

enum DossierStep {
  PROFILE
  OPTIONS
  BUDGET
  DOCUMENTS
  SUBMISSION
}

enum PathType {
  STUDIES
  WORK
  ENTREPRENEUR
}

// ===== DOCUMENTS =====
model Document {
  id          String   @id @default(cuid())
  dossierId   String
  dossier     Dossier  @relation(fields: [dossierId], references: [id], onDelete: Cascade)
  
  type        DocType
  name        String
  status      DocStatus @default(PENDING)
  
  fileUrl     String?
  s3Key       String?
  fileSize    Int?
  mimeType    String?
  
  uploadedAt  DateTime?
  validatedAt DateTime?
  validatedBy String? // Admin ID
  
  rejectionReason String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([dossierId])
  @@index([type])
}

enum DocType {
  PASSPORT
  DIPLOMA
  TRANSCRIPT
  LANGUAGE_TEST
  BIRTH_CERT
  PROOF_ADDRESS
  WORK_LETTER
  TAX_RETURN
  OTHER
}

enum DocStatus {
  PENDING
  RECEIVED
  VALIDATED
  REJECTED
  REQUIRES_UPDATE
}

// ===== MESSAGES & CHAT =====
model Message {
  id        String   @id @default(cuid())
  dossierId String
  dossier   Dossier  @relation(fields: [dossierId], references: [id], onDelete: Cascade)
  
  senderId  String
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)
  
  content   String
  isRead    Boolean  @default(false)
  
  attachmentUrl String?
  
  createdAt DateTime @default(now())
  
  @@index([dossierId])
  @@index([senderId])
}

// ===== COMMUNITY (INSIDE) =====
model Post {
  id        String   @id @default(cuid())
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  title     String
  content   String
  category  Category
  
  views     Int      @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  comments  Comment[]
  tags      PostTag[]

  @@index([authorId])
  @@index([category])
}

model Comment {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  content   String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId])
  @@index([authorId])
}

enum Category {
  WORK
  DOCUMENTS
  STUDIES
  IMMIGRATION
  BUDGETING
  GENERAL
}

model Tag {
  id    String   @id @default(cuid())
  name  String   @unique
  
  posts PostTag[]
}

model PostTag {
  postId String
  post   Post   @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  tagId  String
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([postId, tagId])
}

// ===== EVENTS (LIVE WEBINAIRES) =====
model Event {
  id            String   @id @default(cuid())
  title         String
  description   String
  
  startDate     DateTime
  endDate       DateTime
  
  speaker       String
  category      EventCategory
  
  maxCapacity   Int?
  registrations EventRegistration[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([startDate])
}

enum EventCategory {
  WEBINAR
  WORKSHOP
  NETWORKING
  LIVE_Q_A
}

model EventRegistration {
  id        String   @id @default(cuid())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  status    RegStatus @default(REGISTERED)
  
  registeredAt DateTime @default(now())

  @@unique([eventId, userId])
  @@index([eventId])
}

enum RegStatus {
  REGISTERED
  ATTENDED
  CANCELLED
}

// ===== NOTIFICATIONS =====
model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      NotifType
  title     String
  message   String
  relatedId String? // Dossier ID, Post ID, etc.
  
  isRead    Boolean  @default(false)
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isRead])
}

enum NotifType {
  DOC_REQUEST
  MESSAGE
  STEP_UPDATE
  EVENT_REMINDER
  SYSTEM
}

// ===== INTERNAL (PROFESSIONALS) =====
model InternalNote {
  id        String   @id @default(cuid())
  dossierId String
  dossier   Dossier  @relation(fields: [dossierId], references: [id], onDelete: Cascade)
  
  authorId  String
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  content   String
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dossierId])
}

// ===== CHECKLIST =====
model DossierChecklist {
  id        String   @id @default(cuid())
  dossierId String
  dossier   Dossier  @relation(fields: [dossierId], references: [id], onDelete: Cascade)
  
  title     String
  description String?
  completed Boolean  @default(false)
  
  completedAt DateTime?
  
  @@index([dossierId])
}

// ===== AUDIT =====
model AuditLog {
  id        String   @id @default(cuid())
  userId    String
  action    String
  resource  String
  resourceId String
  changes   String? // JSON
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}
